{{- /*
ConfigMap for OnlyOffice Document Server configuration
*/ -}}
{{- if .Values.configMap.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "onlyoffice-documentserver.fullname" . }}-config
  labels:
    {{- include "onlyoffice-documentserver.labels" . | nindent 4 }}
data:
  # OnlyOffice Document Server configuration with cache expiration settings
  local.json: |
    {
      "services": {
        "CoAuthoring": {
          "sql": {
            "type": "postgres",
            "dbHost": "{{ include "onlyoffice-documentserver.database.host" . }}",
            "dbPort": "{{ include "onlyoffice-documentserver.database.port" . }}",
            "dbName": "{{ .Values.postgresql.externalDatabase.database }}",
            "dbUser": "{{ .Values.postgresql.externalDatabase.username }}",
            "dbPass": "{{ .Values.postgresql.externalDatabase.password }}"
          },
          "expire": {
            "files": {{ .Values.configMap.onlyofficeConfig.expire.files }},
            "filesCron": "{{ .Values.configMap.onlyofficeConfig.expire.filesCron }}"
          },
          "request-filtering-agent": {
            "allowPrivateIPAddress": true,
            "allowMetaIPAddress": true
          }
        }
      },
      "storage": {
        "fs": {
          "folderPath": "/var/lib/onlyoffice-storage",
          "urlExpires": {{ .Values.configMap.onlyofficeConfig.storage.urlExpires }},
          "secretString": "YZzod7XezKhBZRbJHc4C"
        },
        "urlExpires": {{ .Values.configMap.onlyofficeConfig.storage.urlExpires }}
      },
      "rabbitmq": {
        "url": "amqp://{{ include "onlyoffice-documentserver.rabbitmq.username" . }}:{{ include "onlyoffice-documentserver.rabbitmq.password" . }}@{{ include "onlyoffice-documentserver.rabbitmq.host" . }}:{{ include "onlyoffice-documentserver.rabbitmq.port" . }}"
      }
    }
{{- end }}
